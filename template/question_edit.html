<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/template/resource/app.css" rel="stylesheet">
    <script src="/template/resource/jquery.min.js"></script>
    <link href="/template/resource/bootstrap.min.css" rel="stylesheet">
    <script src="/template/resource/bootstrap.bundle.min.js"></script>
    <link rel="icon" href="/favicon.png" type="image/png" sizes="16x16">
    <title>Question Edit</title>
</head>

<body>

    <!-- HEADER -->
    <?php include __DIR__.'/static/header.html';?>

    <!-- BODY -->
    <div class="container mt-4">

        <!-- question form -->
        <div class="row">
            <div class="col-12 col-md-8 col-lg-6 m-auto">
                <form action="/question/save" method="post">
                    <input name="id" type="hidden" value="<?php echo $question->id ?>">
                    <input name="exam_id" type="hidden" value="<?php echo $question->exam_id ?>">
                    <input name="categoryId" type="hidden" id="categoryId" value="<?php echo $question->category_id ?>">

                    <div class="form-group">
                        <label class="h5 text-secondary mb-3">Question</label>
                        <textarea name="question" type="text" class="form-control" placeholder="Question" rows="6"
                            autocomplete="off" minlength="6" maxlength="590" id="questionStr"
                            required><?php echo $question->question ?></textarea>
                    </div>

                    <div class="form-group mt-2" id="qstOptions">
                        <label class="small">Options</label>

                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">1</span>
                            </div>
                            <input name="optionOne" type="text" class="form-control" placeholder="Option 1"
                                autocomplete="off" id="option1" minlength="1" maxlength="280"
                                value="<?php echo $question->option_one ?>" required>
                        </div>

                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">2</span>
                            </div>
                            <input name="optionTwo" type="text" class="form-control" placeholder="Option 2"
                                autocomplete="off" id="option2" minlength="1" maxlength="280"
                                value="<?php echo $question->option_two ?>" required>
                        </div>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">3</span>
                            </div>
                            <input name="optionThree" type="text" class="form-control" placeholder="Option 3"
                                autocomplete="off" id="option3" minlength="1" maxlength="280"
                                value="<?php echo $question->option_three ?>" required>
                        </div>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">4</span>
                            </div>
                            <input name="optionFour" type="text" class="form-control" placeholder="Option 4"
                                autocomplete="off" id="option4" minlength="1" maxlength="280"
                                value="<?php echo $question->option_four ?>" required>
                        </div>
                    </div>


                    <div class="row mt-2">
                        <div class="col">
                            <div class="form-group" style="position: relative">
                                <label class="small">Category</label>
                                <input name="categoryName" id="categorySearchQuery" type="text" class="form-control"
                                    placeholder="Category" autocomplete="off" value="<?php echo $category->title ?>"
                                    required>
                                <ul class="list-group list-group-flush bg-white border border-primary shadow-sm rounded"
                                    id="autocompleteResult"
                                    style="position: absolute; bottom:50px; z-index: 100; width: 100%; display: none;">
                                </ul>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label class="small">Ans</label>
                                <select name="ans" class="form-control" id="ansOption" required>
                                    <option disabled hidden style='display: none' value='0'></option>
                                    <option value="1" <?php echo $question->ans == 1 ? 'selected' : '' ?> >Option 1
                                    </option>
                                    <option value="2" <?php echo $question->ans == 2 ? 'selected' : '' ?>>Option 2
                                    </option>
                                    <option value="3" <?php echo $question->ans == 3 ? 'selected' : '' ?>>Option 3
                                    </option>
                                    <option value="4" <?php echo $question->ans == 4 ? 'selected' : '' ?>>Option 4
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 mb-5 pt-3 border-top">
                        <div class="row">
                            <div class="col">
                                <?php if(!empty($question->id)) { ?>
                                <a id="delete"
                                    href="/question/delete/<?php echo $question->exam_id ?>/<?php echo $question->id ?>"
                                    class="btn btn-sm btn-light">Delete</a>
                                <?php } ?>
                            </div>
                            <div class="col">
                                <button type="submit" class="btn btn-sm btn-primary float-end">Save Question</button>
                                <a href="/question/list/<?php echo $question->exam_id ?>"
                                    class="btn btn-sm btn-secondary me-2 float-end">Close</a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>


            <!-- auto detect -->
            <?php if ($_SESSION['email']=='quiz@admin.com' || $_SESSION['email']=='computer@mcqschools.com') { ?>
            <div class="col-12 col-md-4 col-lg-6">
                <div class="h5 mb-3"> Auto Detect</div>
                <div class="mb-3">
                    <textarea class="form-control" id="autoDetectQuestion" rows="12"></textarea>
                </div>

                <script>
                    // autoDetectQuestion
                    option1Match = ["(A)", "(a)", "A)", "a)", "A.", "a.", "A -", "a -", "1."];
                    option2Match = ["(B)", "(b)", "B)", "b)", "B.", "b.", "B -", "b -", "2."];
                    option3Match = ["(C)", "(c)", "C)", "c)", "C.", "c.", "C -", "c -", "3."];
                    option4Match = ["(D)", "(d)", "D)", "d)", "D.", "d.", "D -", "d -", "4."];
                    optionAnsMatch = ["Ans:", "ANS:", "Ans -", "ANS -", "Answer"];

                    $("#autoDetectQuestion").change(function () {
                        var text = $("#autoDetectQuestion").val().split("\n");
                        var questionText = '';
                        var i = 0;
                        for (i = 0; i < text.length; i++) {
                            if(isOption(text[i], text[i+1]))
                                break;
                            questionText += '\n'+text[i];
                        };

                        $("#questionStr").val(questionText.trim());
                        $("#option1").val(validateString(text[i], "option1"));
                        $("#option2").val(validateString(text[++i], "option2"));
                        $("#option3").val(validateString(text[++i], "option3"));
                        $("#option4").val(validateString(text[++i], "option4"));

                        ans_flag = false;
                        ans = validateString(text[++i], "ans").replace(/[^a-zA-Z0-9]/g, '').trim();
                        if (ans == 1 || ans == 'A' || ans == 'a'){ $('#ansOption option[value="1"]').prop('selected', true); ans_flag = true; }
                        if (ans == 2 || ans == 'B' || ans == 'b'){ $('#ansOption option[value="2"]').prop('selected', true); ans_flag = true; }
                        if (ans == 3 || ans == 'C' || ans == 'c'){ $('#ansOption option[value="3"]').prop('selected', true); ans_flag = true; }
                        if (ans == 4 || ans == 'D' || ans == 'd'){ $('#ansOption option[value="4"]').prop('selected', true); ans_flag = true; }

                        if(ans_flag){
                            $("#autoDetectQuestion").removeClass("border-danger");
                            $("#autoDetectQuestion").addClass("border-success");
                        }else{
                            $("#autoDetectQuestion").removeClass("border-success");
                            $("#autoDetectQuestion").addClass("border-danger");
                        }

                    });

                    // validate text
                    function validateString(str, selector){
                        result = undefined;
                        badTextArray = [];
                        str = str.trim();
                        if(selector == 'option1') badTextArray = option1Match;
                        else if(selector == 'option2') badTextArray = option2Match;
                        else if(selector == 'option3') badTextArray = option3Match;
                        else if(selector == 'option4') badTextArray = option4Match;
                        else if(selector == 'ans') badTextArray = optionAnsMatch;

                        if(str);
                        badTextArray.forEach(element => {
                            if(str.indexOf(element)==0){
                                if(!result)
                                result = str.replace(element, "").trim();
                            }
                        });
                        return result;
                    }

                    // check for option
                    function isOption(line1, line2){
                        line1_flag = false;
                        line2_flag = false;
                        line1 = line1.trim();
                        line2 = line2.trim();
                        option1Match.forEach(element => {
                            if(line1.indexOf(element)==0)
                                line1_flag = true;
                        });
                        
                        if(line1_flag)
                        option2Match.forEach(element => {
                            if(line2.indexOf(element)==0)
                                line2_flag = true;
                        });

                        if(line1_flag && line2_flag) return true;
                        else return false;
                    }
                </script>
            </div>
            <?php } ?>
            <!-- auto detect -->

        </div>
    </div>


    <!-- FOOTER -->
    <?php include __DIR__.'/static/footer.html';?>


    <script>
        var firstCategoryFocus = false;
        var autocompleteList = [];
        var timer = 0;
        $(document).ready(function () {

            // ctegory -------------------------------------------------------------------------

            // auto complete
            $("#categorySearchQuery").keyup(function () {
                if (timer) { clearTimeout(timer); }
                timer = setTimeout(categoryQuerySuggest, 400);
            });

            // first category input focus
            $("#categorySearchQuery").focus(function () {
                categoryQuerySuggest();
            });

            // on select set category id input
            $("body").on("click", "ul#autocompleteResult li", function () {
                catStr = $(this).text().trim();
                $.each(autocompleteList, function (key, value) {
                    if (catStr == value.title) {
                        $("#categorySearchQuery").val(catStr);
                        $("#categoryId").val(value.id);
                        setCookie("questionCategorySuggest", catStr, 365);
                    }
                });
                $("#autocompleteResult").hide();
            });

            function categoryQuerySuggest() {
                var searchStr = $("#categorySearchQuery").val().trim();
                if (searchStr.length == 0)
                    searchStr = getCookie("questionCategorySuggest");

                if (searchStr.length > 0) {
                    $.ajax({
                        type: 'GET',
                        //dataType: 'JSON',
                        url: "/category/autocomplete/" + searchStr,
                        success: function (result) {
                            $("#autocompleteResult").empty();
                            $("#autocompleteResult").show();
                            result = JSON.parse(result);
                            autocompleteList = result;
                            $.each(result, function (key, obj) {
                                $("#autocompleteResult").append('<li class="list-group-item grayHover p-2"><a href="#" class="text-decoration-none d-block text-dark">' + obj.title + '</a></li>');
                            });
                            if (result.length == 0)
                                $("#autocompleteResult").hide();
                        }
                    });
                } else {
                    $("#autocompleteResult").hide();
                }
            }


            // set cookie
            function setCookie(cname, cvalue, exdays) {
                var d = new Date();
                d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
                var expires = "expires=" + d.toUTCString();
                document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
            }

            // get cookie
            function getCookie(cname) {
                var name = cname + "=";
                var ca = document.cookie.split(';');
                for (var i = 0; i < ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0) == ' ') {
                        c = c.substring(1);
                    }
                    if (c.indexOf(name) == 0) {
                        return c.substring(name.length, c.length);
                    }
                }
                return "";
            }




            //option -----------------------------------------------------------------------------

            // set option background color
            option_bg_flag = true
            $('#categorySearchQuery').on("focus", function () {
                if (option_bg_flag) {
                    $("#option1").addClass("bg-option");
                    option_bg_flag = false;
                }
            });

            // on ans select change option background color
            $('#ansOption').on("change", function () {
                $("#qstOptions input").removeClass("bg-option");
                $("#option" + this.value).addClass("bg-option");
                option_bg_flag = false;
            });

            // on load check ans
            ansVal = $('#ansOption').find(":selected").val();
            inputValue = $("#option" + ansVal).val().trim();
            if (ansVal != undefined && inputValue) {
                $("#option" + ansVal).addClass("bg-option");
                option_bg_flag = false;
            }

            /*
            // validaton --------------------------------------------------------------------------------
            $("#questionStr").change(function(){
                $("#questionStr").val( validateString($("#questionStr").val()) );
            });
            $("#option1").change(function(){
                $("#option1").val( validateString($("#option1").val()) );
            });
            $("#option2").change(function(){
                $("#option2").val( validateString($("#option2").val()) );
            });
            $("#option3").change(function(){
                $("#option3").val( validateString($("#option3").val()) );
            });
            $("#option4").change(function(){
                $("#option4").val( validateString($("#option4").val()) );
            });

            function validateString(str){
                //str = str.replaceAll("'","`");
                //str = str.replaceAll('"','');
                return str;
            }
            */

            // delete question
            $('#delete').click(function () {
                return confirm('Are you sure you want to delete');
            });

        });


    </script>
</body>

</html>